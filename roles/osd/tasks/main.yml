# Copyright (c) 2022 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Install packages
  ansible.builtin.apt:
    name: ["openssh-server", "ceph-common"]
    install_recommends: false

- name: Enable sshd Root Login
  ansible.builtin.lineinfile:
    dest: /etc/ssh/sshd_config
    regexp: '^\#?\s?PermitRootLogin.*$'
    line: "    PermitRootLogin yes"
    state: present
    backup: true
  become: true

- name: Make sure sshd is started
  ansible.builtin.service:
    name: sshd
    state: started

- name: Make sure docker is started
  ansible.builtin.service:
    name: docker
    state: started

- name: Set authorized key
  ansible.posix.authorized_key:
    user: root
    key: "{{ ceph_ssh_pub_key }}"
    state: present
  when:
    - ceph_ssh_pub_key is defined

- name: Add osd host to ceph cluster
  ansible.builtin.command:
    ceph orch host add "{{ inventory_hostname_short }}" \
    "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(ceph_mon_public_network) | first }}" --labels=osd  # yamllint disable-line rule:line-length
  changed_when: false

- name: Apply osd spec file
  ansible.builtin.command:
    cmd: ceph orch apply -i {{ ceph_osd_spec_file }}
  when:
    - ceph_osd_spec_file is defined
  changed_when: false

- name: Apply osd spec file with default spec
  run_once: true
  when:
    - ceph_osd_spec_file is not defined
  block:
    - name: Generate temporary file for osd spec
      ansible.builtin.tempfile:
        state: file
        prefix: ceph_osd_spec
      register: _ceph_osd_default_spec
      changed_when: false

    - name: Write osd spec file
      become: true
      ansible.builtin.template:
        src: osd_spec.j2
        dest: "{{ _ceph_osd_default_spec.path }}"
        mode: '0640'
      changed_when: false

    - name: Apply osd spec file
      ansible.builtin.command:
        cmd: ceph orch apply -i {{ _ceph_osd_default_spec.path }}
      changed_when: false

    - name: Remove the temporary config file
      ansible.builtin.file:
        path: "{{ _ceph_osd_default_spec.path }}"
        state: absent
      when: _ceph_osd_default_spec.path is defined
      changed_when: false
