# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Set ceph monitor ip address
  ansible.builtin.set_fact:
    ceph_mon_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(ceph_mon_public_network) | first }}"

- name: Generate temporary file for ceph cfg
  become: true
  ansible.builtin.tempfile:
    state: file
    prefix: ceph_cfg
  register: _ceph_cfg_tempfile

- name: Generate basic configuration file
  community.general.ini_file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    section: global
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: "0640"
  loop:
    - option: fsid
      value: "{{ ceph_mon_fsid }}"
    - option: mon_host
      value: "{{ groups[ceph_mon_group] | map('extract', hostvars, ['ceph_mon_ip_address']) | join(',') }}"
    - option: public_network
      value: "{{ ceph_mon_public_network }}"
    - option: cluster_network
      value: "{{ ceph_mon_cluster_network }}"

- name: Include extra configuration values
  ansible.builtin.ini_file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: "0640"
  loop: "{{ ceph_mon_conf_overrides }}"

- name: Run Bootstrap coomand
  ansible.builtin.command:
    cmd: cephadm bootstrap --mon-ip {{ ceph_mon_ip_address }} --config {{ _ceph_cfg_tempfile.path }} --allow-overwrite
  changed_when: false

# TODO(ricolin): should validate on cluster bootstrap
#
- name: Add mon and mgr label to bootstrap host
  ansible.builtin.command:
    cmd: ceph orch label add "{{ inventory_hostname_short }}" mon, mgr
  changed_when: false

- name: Load ssh pub key
  ansible.builtin.slurp:
    src: /etc/ceph/ceph.pub
  register: ssh_pub_key

- name: Set global var `ceph_ssh_pub_key`
  ansible.builtin.set_fact:
    ceph_ssh_pub_key: "{{ ssh_pub_key['content'] | b64decode }}"

- name: Remove the temporary config file
  ansible.builtin.file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    state: absent
  when: _ceph_cfg_tempfile.path is defined
