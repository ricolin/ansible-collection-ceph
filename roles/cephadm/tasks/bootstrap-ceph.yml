# Copyright (c) 2023 VEXXHOST, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

- name: Set ceph monitor ip address
  ansible.builtin.set_fact:
    ceph_mon_ip_address: "{{ ansible_all_ipv4_addresses | ansible.utils.ipaddr(ceph_mon_public_network) | first }}"

- name: Generate temporary file for ceph cfg
  become: true
  ansible.builtin.tempfile:
    state: file
    prefix: ceph_cfg
  register: _ceph_cfg_tempfile

- name: Generate basic configuration file
  community.general.ini_file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    section: global
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: "0640"
  loop:
    - option: fsid
      value: "{{ ceph_mon_fsid }}"
    - option: public_network
      value: "{{ ceph_mon_public_network }}"
    - option: cluster_network
      value: "{{ ceph_mon_cluster_network }}"

- name: Include extra configuration values
  ansible.builtin.ini_file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    section: "{{ item.section }}"
    option: "{{ item.option }}"
    value: "{{ item.value }}"
    mode: "0640"
  loop: "{{ ceph_mon_conf_overrides }}"

- name: Run Bootstrap coomand
  ansible.builtin.command:
    cmd: cephadm bootstrap --mon-ip {{ ceph_mon_ip_address }} --config {{ _ceph_cfg_tempfile.path }} --allow-overwrite
  changed_when: false

- name: Validate bootstrap
  ansible.builtin.command: ceph orch status
  register: bootstrap_status
  until: >
    'Available: Yes' in bootstrap_status.stdout and
    'Backend: cephadm' in bootstrap_status.stdout
  retries: 120
  delay: 5
  changed_when: false
  failed_when: bootstrap_status.rc > 1

- name: Load ssh pub key
  ansible.builtin.slurp:
    src: /etc/ceph/ceph.pub
  register: ssh_pub_key

- name: Set global var `ceph_ssh_pub_key`
  ansible.builtin.set_fact:
    ceph_ssh_pub_key: "{{ ssh_pub_key['content'] | b64decode }}"
  delegate_to: "{{ item }}"
  with_items: "{{ ansible_play_hosts }}"
  run_once: true

- name: Remove the temporary config file
  ansible.builtin.file:
    path: "{{ _ceph_cfg_tempfile.path }}"
    state: absent
  when: _ceph_cfg_tempfile.path is defined

- name: Add osd hosts to ceph cluster
  ansible.builtin.command:
    ceph orch host add "{{ inventory_hostname_short }}" "{{ item }}" --labels=osd  # yamllint disable-line rule:line-length
  loop: "{{ groups[ceph_osd_group] | map('extract', hostvars, ['osd_ip']) }}"  # yamllint disable-line rule:line-length
  changed_when: false

- name: Generate temporary file for osd spec
  ansible.builtin.tempfile:
    state: file
    prefix: ceph_osd_spec
  register: _ceph_osd_spec_tmp
  changed_when: false

- name: Write osd spec file
  become: true
  ansible.builtin.file:
    src: "{{ lookup('ansible.builtin.file', ceph_osd_spec_file) }}"
    dest: "{{ _ceph_osd_spec_tmp.path }}"
    mode: '0640'
  when:
    - ceph_osd_spec_file is defined
  changed_when: false

- name: Write osd spec file
  become: true
  ansible.builtin.template:
    src: osd_spec.j2
    dest: "{{ _ceph_osd_spec_tmp.path }}"
    mode: '0640'
  changed_when: false
  when:
    - ceph_osd_spec_file is not defined

- name: Apply osd spec file
  ansible.builtin.command:
    cmd: ceph orch apply -i {{ _ceph_osd_spec_tmp.path }}
  when:
    - ceph_osd_spec_file is defined
  changed_when: false

- name: Remove the temporary config file
  ansible.builtin.file:
    path: "{{ _ceph_osd_spec_tmp.path }}"
    state: absent
  when: _ceph_osd_spec_tmp.path is defined
  changed_when: false
